<h1>{{title}}</h1>
{{#with post}}
<h2 class="text-xl">{{title}}</h2>
{{!-- <h2 class="text-xl">제목</h2> --}}
<div>
    {{!-- 작성자: <b>작성자 이름</b> --}}
    작성자: <b>{{writer}}</b>
</div>
<div>
    {{!-- 조회수: 9999 | 작성일시: 2023-01-01 00:00:00
    <button onclick="//modifyPost()">수정</button>
    <button onclick="//deletePost()">삭제</button> --}}
    조회수: {{hits}} | 작성일시: {{dataString createDt}}
    <button onclick="modifyPost()">수정</button>
    <button onclick="deletePost()">삭제</button>
</div>

<div>
    {{!-- <pre>본문</pre> --}}
    <pre>{{content}}</pre>
</div>

<section>
    <div>
        {{!-- <h3>n개의 댓글</h3> --}}
        <h3>{{lengthOfList comments}}개의 댓글</h3>
    </div>

    <form method="post" action="/write-comment">
    <input type="hidden" name="id" value="{{_id}}">
    <div>
        <div>
            <input type="text" name="name" placeholder="이름">
            <input type="password" name="password" placeholder="패스워드">
        </div>
        <div>
            <textarea cols="40" rows="3" name="comment" placeholder="댓글 입력"></textarea>
            <br><br><button>댓글 작성</button>
        </div>
    </div>
    </form>
</section>

<section>
    {{#each comments}}
    <div>
        <div>
            {{!-- 작성자: <b>댓글 작성자</b> --}}
            작성자: <b>{{name}}</b>
        </div>
        <div>
            {{!-- 작성일시: 2023-01-01 00:00:00
            <button onclick="//deleteComment('1')">삭제</button> --}}
            작성일시: {{dataString createDt}}
            <button onclick="deleteComment('{{idx}}')">삭제</button>
        </div>
    </div>
    <div>
        <pre>{{comment}}</pre>
    </div>
    {{/each}}
</section>

{{/with}}

<footer>
    <div>
        <a href="/">목록으로 이동</a>
    </div>
</footer>

<script>
    const postOption = {
        method: "POST",
        headers: {
            'Content-Type': 'application/json',
        },
    }

    async function modifyPost() { 
        const password = prompt("패스워드 입력");
        //취소를 누른 경우 처리
        if(!password) {
            return;
        }

        //check-password API 실행
        const result = await fetch('/check-password', {
            ...postOption,
            body: JSON.stringify({ id: '{{post._id}}', password })
        });

        //json 함수를 실행하는 경우도 await 필요
        const data = await result.json();

        //패스워드가 맞는 경우 수정 페이지로 이동
        if(data.isExist) {
            document.location = '/modify/{{post._id}}';
        }
        else {
            alert('패스워드 틀림!');
        }
    }

    const deleteOption = {
        method: 'DELETE',
        headers: {
        'Content-Type': 'application/json',
        },
    };

    async function deletePost() { 
        const password = prompt('패스워드 입력');
        if(!password) {
            return;
        }

        //fetch API를 사용해 delete API 호출
        const result = await fetch('/delete', {
            ...deleteOption,
            body: JSON.stringify({ id: '{{post._id}}', password })
        });

        //delete API의 결과에 따른 메시지 출력
        const data = await result.json();
        if(!data.isSuccess) {
            alert('삭제 실패');
            return;
        }

        //성공에 대한 출력
        alert('삭제 성공');
        document.location = '/';
    }

    async function deleteComment(idx) {
        const password = prompt('패스워드 입력');

        if(!password) {
            return;
        }

        //delete-comment API 실행
        const result = await fetch('/delete-comment', {
            ...deleteOption,
            body: JSON.stringify({ id: '{{post._id}}', idx, password })
        });

        //댓글 삭제 실패
        const data = await result.json();
        if(!data.isSuccess) {
            alert('삭제 실패');
            return;
        }

        //삭제 성공
        alert('삭제 성공');
        document.location.reload();
    }
</script>